# AI 実装ガイドライン（k3-live-manager）

この文書は、AIアシスタントが本リポジトリで安全かつ一貫した変更を行うための指示集です。

## 目的

- 設計意図を壊さずに、最小差分で課題を解決する
- セキュリティ・運用を優先し、事故（秘密情報流出・互換性破壊）を防止

## 絶対遵守の設計制約

- ポート: OAuth コールバックは固定 1421（単一接続のみ）
- DB パス: `sqlite:../app.sqlite`
- 層分離: UI → commands → services → repositories
- CSRF 対策: OAuth state の発行と検証を必須
- トークン: ログに出力しない（アクセストークン/リフレッシュトークン）

## 変更ポリシー

- 変更してよい
  - バグ修正、型/ビルドエラー解消、同一機能の効率化（挙動非変更）
  - ドキュメントの追加/更新（Mermaid 図を含む）
- 事前合意なく変更してはならない
  - ポート/DB パス/アプリ構成、公開 API シグネチャ、UI の見た目の大きな変更
  - セキュリティ境界（権限、保存先、ログ出力方針）

## 実装ルール（要点）

- Service はビジネスロジック・検証を担当。Repository は SQL/DB I/O のみ
- 資格情報の参照は `get_credential_by_id` を使用（全件取得→filter は禁止）
- `oauth_tokens.credentials_id` はユニーク。保存は upsert（更新 or 追加）
- 例外は `anyhow::Result` + `Context` で原因連結。UI には文字列化で返却
- コールバック HTML は日本語、5秒で自動クローズ

## コマンド/実行（Windows PowerShell）

```powershell
# 開発起動
yarn tauri dev

# テスト（Rust 側）
cargo test
```

## Git/セキュリティ運用

- `.gitignore` により SQLite はコミットしない
- 秘密検出でブロック時の対処: 追跡解除 → 履歴から完全削除 → 強制 push
- コミットメッセージ: `feat:`, `fix:`, `chore:`, `docs:` などの接頭辞を推奨

## ドキュメント更新ルール

- 変更が公共API/DB/フローに影響する場合、必ず `doc/*` を更新
- 図が有用な場合は Mermaid を使用（ER/シーケンス/フロー）
- 設計と実装は必ず前後関係を明記し、実装ファイルと1対1の仕様書を `doc/specs/<相対パス>.md` として作成/更新（ユースケース、入出力、前提条件、異常系、テスト含む）
- 仕様書はバックエンド（コマンド/サービス/リポジトリ）とフロントエンド（ページ/コンポーネント）の双方で作成し、フロントの場合は対象URLを必ず明記
- 関連の連動更新を厳守（例: コマンド引数名変更→対応するフロントinvoke、仕様書、関連ドキュメントを同時に更新）
- 設計変更や新規機能の場合は、実装前にユーザーの許可を得てから設計書を更新し、その後に実装・テストを行う

## 返信スタイル

- 簡潔・丁寧・箇条書き中心。不要な謝罪や冗長な前置きは避ける
- 実行可能な最小差分の提案と即時反映（可能な限りツールで実施）

## 依頼テンプレート

- 変更依頼（小規模）
  - 目的:
  - 対象ファイル/箇所:
  - 期待する挙動:
- 変更依頼（影響大）
  - 目的/背景:
  - 影響範囲（API/DB/UI/設定）:
  - ロールバック方針:

## AI 内部チェックリスト

1) 変更の性質を分類：設計変更/新規作成/実装のみの修正
2) 設計変更・新規作成なら、実装の前にユーザーへ確認して許可を取得
3) 設計書を更新（`doc/architecture.md` や `doc/database.md`、必要に応じて `doc/specs/<相対パス>.md` を新規作成）
4) 設計と前後関係・ユースケースを1対1の仕様書に反映（入出力・前提・異常系・テスト計画）
5) 実装を最小差分で行い、ビルド/静的チェック/テストを実施
6) セキュリティ（秘密ログ/トークン/CSRF）を再確認
7) ドキュメントと実装の同期（差分の取りこぼしがないか）

```mermaid
flowchart TD
  A[依頼受領] --> B{変更種別?}
  B -- 設計変更/新規 --> C[ユーザー承認取得]
  C --> D[設計書更新/新規作成<br/>doc/specs に1対1仕様書]
  D --> E[実装(最小差分)]
  B -- 実装のみ --> E[実装(最小差分)]
  E --> F[ビルド/テスト/静的チェック]
  F --> G[セキュリティ確認(秘密/CSRF/ログ)]
  G --> H[ドキュメント同期確認]
  H --> I[完了報告]
```
